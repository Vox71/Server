pipeline {
    agent any

    environment {
        DOCKER_COMPOSE_FILE = 'docker-compose.yml'
        SQL_EXPORT = 'export.sql'
        DOCKERFILE = 'Dockerfile'
        NGINX_CONF = 'nginx.conf'
        REQ_FILE = 'requirements.txt'
        DEPLOY_HOST = 'jbuk@192.168.3.68' // Замените на ваш удаленный хост
        DEPLOY_PATH = '/home/jbuk' // Замените на путь, куда вы хотите развернуть
    }

    stages {
        stage('Build') {
            steps {
                script {
                    // Сборка проекта локально
                    sh "docker-compose -f ${DOCKER_COMPOSE_FILE} build"
                }
            }
        }

        stage('Deploy') {
            steps {
                script {
                    // Копирование docker-compose.yml на удаленный хост
                    sh "scp ${DOCKER_COMPOSE_FILE} ${DEPLOY_HOST}:${DEPLOY_PATH}"
                    sh "scp ${SQL_EXPORT} ${DEPLOY_HOST}:${DEPLOY_PATH}"
                    sh "scp ${DOCKERFILE} ${DEPLOY_HOST}:${DEPLOY_PATH}"
                    // Выполнение docker-compose на удаленном хосте
                    sh "ssh ${DEPLOY_HOST} 'cd ${DEPLOY_PATH} && docker-compose -f ${DOCKER_COMPOSE_FILE} up -d'"
                }
            }
        }
    }

    post {
        success {
            echo 'Deployment completed successfully!'
        }
        failure {
            echo 'Deployment failed.'
        }
    }
}